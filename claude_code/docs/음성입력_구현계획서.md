# 음성 입력 기반 심장 건강 검사 시스템 구현 계획서

## 개요

OpenAI Realtime API를 활용한 음성 대화형 심장 건강 검사 폼 입력 시스템 구현 계획서입니다. 사용자는 음성으로 17개 질문에 답변하며, AI가 자동으로 검사 폼을 작성합니다.

---

## 1. 시스템 아키텍처

### 전체 흐름도
```
사용자 음성 → 프론트엔드 (React Native) → OpenAI Realtime API
                ↓
    음성 응답 ← AI 에이전트 (대화 관리자)
                ↓
    폼 데이터 → 백엔드 API → 데이터베이스
                ↓
    분석 결과 → 사용자
```

### 기술 스택
- **프론트엔드**: React Native (기존 프로젝트)
- **음성 API**: OpenAI Realtime API (WebSocket 기반)
- **백엔드**: Spring Boot (기존 프로젝트)
- **데이터베이스**: PostgreSQL (기존 프로젝트)

---

## 2. OpenAI Realtime API 분석

### 주요 기능 (2024년 최신)

**Realtime API 특징:**
- WebSocket 기반 실시간 양방향 오디오 스트리밍
- 저지연 음성 대화 (200-500ms)
- Function Calling을 통한 구조화된 데이터 추출
- 세션 기반 대화 컨텍스트 관리
- 자동 음성 인식(ASR) + 음성 합성(TTS) 통합

**API 엔드포인트:**
```
wss://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-10-01
```

**이 프로젝트에 필요한 핵심 기능:**
1. **Function Calling**: 음성에서 구조화된 답변 추출
2. **세션 관리**: 다중 턴 대화 추적
3. **오디오 스트리밍**: 네이티브 음성 입출력
4. **턴 감지**: 사용자 발화 완료 자동 감지

---

## 3. 대화 흐름 설계

### 대화 상태 머신

```typescript
enum ConversationState {
  INTRO = 'intro',                    // 시작 안내
  CONFIRM_READY = 'confirm_ready',    // 준비 확인
  BASIC_INFO = 'basic_info',          // 기본 정보 (6문항)
  SYMPTOMS = 'symptoms',              // 증상 체크 (11문항)
  COMPLETION = 'completion',          // 완료 안내
  CANCELLED = 'cancelled'             // 취소됨
}

enum QuestionType {
  GENDER = 'gender',              // 성별: 남자/여자
  AGE = 'age',                    // 나이: 숫자
  WEIGHT = 'weight',              // 몸무게: 숫자 (kg)
  HEIGHT = 'height',              // 키: 숫자 (cm)
  BODY_TEMP = 'bodyTemperature',  // 체온: 낮다/보통/높다
  BREATHING = 'breathing',        // 호흡: 느리다/보통/빠르다
  CHEST_PAIN = 'chestPain',       // 가슴통증: 예/아니오
  FLANK_PAIN = 'flankPain',       // 옆구리통증: 예/아니오
  FOOT_PAIN = 'footPain',         // 발통증: 예/아니오
  EDEMA = 'edemaLegs',            // 발부종: 예/아니오
  DYSPNEA = 'dyspnea',            // 호흡곤란: 예/아니오
  SYNCOPE = 'syncope',            // 실신: 예/아니오
  WEAKNESS = 'weakness',          // 피로감: 예/아니오
  VOMITING = 'vomiting',          // 구토: 예/아니오
  PALPITATION = 'palpitation',    // 두근거림: 예/아니오
  DIZZINESS = 'dizziness'         // 어지러움: 예/아니오
}
```

### 질문 순서 및 검증 규칙

```typescript
interface QuestionConfig {
  id: QuestionType;
  prompt: string;                    // 질문 내용
  expectedAnswers: string[];         // 예상 답변 목록
  validationPattern: RegExp | null;  // 검증 정규식
  retryPrompt: string;              // 재질문 메시지
  maxRetries: number;               // 최대 재시도 횟수
}

const QUESTION_SEQUENCE: QuestionConfig[] = [
  // 기본 정보 질문
  {
    id: 'gender',
    prompt: '고객님의 성별을 말씀해 주세요. "남자" 혹은 "여자"라고 말씀해 주세요.',
    expectedAnswers: ['남자', '여자', 'male', 'female'],
    validationPattern: /^(남자|여자|male|female)$/i,
    retryPrompt: '죄송합니다. "남자" 혹은 "여자"로 다시 말씀해 주세요.',
    maxRetries: 3
  },
  {
    id: 'age',
    prompt: '고객님의 나이는 몇 세인가요? 숫자로 말씀해 주세요.',
    expectedAnswers: [],
    validationPattern: /^(\d{1,3})$/,
    retryPrompt: '숫자로 정확한 나이를 말씀해 주세요.',
    maxRetries: 3
  },
  {
    id: 'weight',
    prompt: '고객님의 몸무게는 몇 kg인가요? 숫자로 말씀해 주세요.',
    expectedAnswers: [],
    validationPattern: /^(\d{2,3})$/,
    retryPrompt: '몸무게를 숫자로 말씀해 주세요.',
    maxRetries: 3
  },
  {
    id: 'height',
    prompt: '고객님의 키는 몇 cm인가요? 숫자로 말씀해 주세요.',
    expectedAnswers: [],
    validationPattern: /^(\d{2,3})$/,
    retryPrompt: '키를 숫자로 말씀해 주세요.',
    maxRetries: 3
  },
  {
    id: 'bodyTemperature',
    prompt: '고객님의 체온 상태는 어떠신가요? "낮다, 보통, 높다" 중에 선택해 주세요.',
    expectedAnswers: ['낮다', '보통', '높다'],
    validationPattern: /^(낮다|보통|높다)$/,
    retryPrompt: '"낮다", "보통", "높다" 중 하나로 말씀해 주세요.',
    maxRetries: 3
  },
  {
    id: 'breathing',
    prompt: '고객님의 호흡 상태는 어떠신가요? "느리다, 보통, 빠르다" 중에 선택해 주세요.',
    expectedAnswers: ['느리다', '보통', '빠르다'],
    validationPattern: /^(느리다|보통|빠르다)$/,
    retryPrompt: '"느리다", "보통", "빠르다" 중 하나로 말씀해 주세요.',
    maxRetries: 3
  },

  // 증상 질문 (예/아니오)
  {
    id: 'chestPain',
    prompt: '고객님은 현재 가슴 통증을 느끼시나요? "예" 또는 "아니오"로 말씀해 주세요.',
    expectedAnswers: ['예', '아니오', 'yes', 'no'],
    validationPattern: /^(예|아니오|yes|no)$/i,
    retryPrompt: '"예" 또는 "아니오"로 말씀해 주세요.',
    maxRetries: 3
  },
  {
    id: 'flankPain',
    prompt: '고객님은 현재 옆구리나 등에 통증을 느끼시나요? "예" 또는 "아니오"로 말씀해 주세요.',
    expectedAnswers: ['예', '아니오', 'yes', 'no'],
    validationPattern: /^(예|아니오|yes|no)$/i,
    retryPrompt: '"예" 또는 "아니오"로 말씀해 주세요.',
    maxRetries: 3
  },
  {
    id: 'footPain',
    prompt: '고객님은 현재 발 통증을 느끼시나요? "예" 또는 "아니오"로 말씀해 주세요.',
    expectedAnswers: ['예', '아니오', 'yes', 'no'],
    validationPattern: /^(예|아니오|yes|no)$/i,
    retryPrompt: '"예" 또는 "아니오"로 말씀해 주세요.',
    maxRetries: 3
  },
  {
    id: 'edemaLegs',
    prompt: '고객님은 현재 발부종, 즉 발에 부기가 있다고 느끼시나요? "예" 또는 "아니오"로 말씀해 주세요.',
    expectedAnswers: ['예', '아니오', 'yes', 'no'],
    validationPattern: /^(예|아니오|yes|no)$/i,
    retryPrompt: '"예" 또는 "아니오"로 말씀해 주세요.',
    maxRetries: 3
  },
  {
    id: 'dyspnea',
    prompt: '고객님은 현재 호흡곤란을 느끼시나요? "예" 또는 "아니오"로 말씀해 주세요.',
    expectedAnswers: ['예', '아니오', 'yes', 'no'],
    validationPattern: /^(예|아니오|yes|no)$/i,
    retryPrompt: '"예" 또는 "아니오"로 말씀해 주세요.',
    maxRetries: 3
  },
  {
    id: 'syncope',
    prompt: '고객님은 현재 말씀 도중에 말이 끊기거나 실신 상태를 느끼시나요? "예" 또는 "아니오"로 말씀해 주세요.',
    expectedAnswers: ['예', '아니오', 'yes', 'no'],
    validationPattern: /^(예|아니오|yes|no)$/i,
    retryPrompt: '"예" 또는 "아니오"로 말씀해 주세요.',
    maxRetries: 3
  },
  {
    id: 'weakness',
    prompt: '고객님은 현재 심한 피로감을 느끼시나요? "예" 또는 "아니오"로 말씀해 주세요.',
    expectedAnswers: ['예', '아니오', 'yes', 'no'],
    validationPattern: /^(예|아니오|yes|no)$/i,
    retryPrompt: '"예" 또는 "아니오"로 말씀해 주세요.',
    maxRetries: 3
  },
  {
    id: 'vomiting',
    prompt: '고객님은 현재 구토 증상을 느끼시나요? "예" 또는 "아니오"로 말씀해 주세요.',
    expectedAnswers: ['예', '아니오', 'yes', 'no'],
    validationPattern: /^(예|아니오|yes|no)$/i,
    retryPrompt: '"예" 또는 "아니오"로 말씀해 주세요.',
    maxRetries: 3
  },
  {
    id: 'palpitation',
    prompt: '고객님은 현재 심장 두근거림 증상을 느끼시나요? "예" 또는 "아니오"로 말씀해 주세요.',
    expectedAnswers: ['예', '아니오', 'yes', 'no'],
    validationPattern: /^(예|아니오|yes|no)$/i,
    retryPrompt: '"예" 또는 "아니오"로 말씀해 주세요.',
    maxRetries: 3
  },
  {
    id: 'dizziness',
    prompt: '고객님은 현재 어지러움 증상을 느끼시나요? "예" 또는 "아니오"로 말씀해 주세요.',
    expectedAnswers: ['예', '아니오', 'yes', 'no'],
    validationPattern: /^(예|아니오|yes|no)$/i,
    retryPrompt: '"예" 또는 "아니오"로 말씀해 주세요.',
    maxRetries: 3
  },
];
```

---

## 4. 구현 단계별 계획

### 1단계: 환경 설정 및 기반 구축 (1주차)
- [ ] OpenAI API 키 발급 및 환경 변수 설정
- [ ] React Native 오디오 라이브러리 설치
- [ ] VoiceCheckScreen 컴포넌트 기본 구조 생성
- [ ] RealtimeClient 서비스 스켈레톤 구현

**필요 라이브러리:**
```bash
npm install react-native-audio-recorder-player
npm install @react-native-community/audio-toolkit
npm install react-native-websocket
```

### 2단계: 핵심 음성 연동 (2주차)
- [ ] OpenAI Realtime API WebSocket 연결 구현
- [ ] 세션 설정 및 시스템 지침 구성
- [ ] 오디오 스트리밍 (입력/출력) 구현
- [ ] 기본 대화 흐름 테스트

**WebSocket 연결 코드:**
```typescript
const url = 'wss://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-10-01';
const ws = new WebSocket(url, {
  headers: {
    'Authorization': `Bearer ${OPENAI_API_KEY}`,
    'OpenAI-Beta': 'realtime=v1',
  },
});
```

### 3단계: 질문 흐름 및 검증 (3주차)
- [ ] 대화 상태 머신 구현
- [ ] 질문 순서 및 검증 로직 구현
- [ ] Function Calling을 통한 데이터 추출
- [ ] 불명확한 답변 재질문 메커니즘 구현

**Function Calling 설정:**
```typescript
{
  type: 'function',
  name: 'update_assessment_data',
  description: '사용자 음성에서 추출한 데이터로 검사 폼 업데이트',
  parameters: {
    type: 'object',
    properties: {
      field: {
        type: 'string',
        enum: ['gender', 'age', 'weight', 'height', ...],
      },
      value: {
        type: 'string',
      },
    },
    required: ['field', 'value'],
  },
}
```

### 4단계: UI/UX 개선 (4주차)
- [ ] 음성 인터페이스 UI 디자인 (마이크 표시, 음성인식 텍스트, 진행률)
- [ ] 오디오 피드백 및 시각적 단서 추가
- [ ] 취소/재시도 기능 구현
- [ ] 접근성 기능 추가

**UI 컴포넌트:**
```typescript
- 상태 표시기 (듣는 중 / 대기 중)
- 진행률 바 (17개 질문 중 현재 위치)
- 실시간 음성인식 텍스트 표시
- 입력된 데이터 미리보기
- 취소/중단 버튼
```

### 5단계: 백엔드 연동 (5주차)
- [ ] 음성 데이터를 CheckRequest DTO로 매핑
- [ ] 데이터 변환 레이어 구현
- [ ] 백엔드와 전체 흐름 테스트
- [ ] 오류 시나리오 및 엣지 케이스 처리

**데이터 매핑:**
```typescript
음성 입력 데이터 → 백엔드 DTO
- gender (남자/여자) → sex (String)
- age (숫자) → age (Integer)
- weight (kg) → kg (Float)
- height (cm) → cm (Float)
- bodyTemperature (낮다/보통/높다) → body_temperature (String)
- breathing (느리다/보통/빠르다) → breathing (String)
- chestPain (예/아니오) → cp (Boolean)
- ... (나머지 증상들도 동일)
```

### 6단계: 테스트 및 최적화 (6주차)
- [ ] 다양한 한국어 억양 및 발음 패턴 테스트
- [ ] 오디오 품질 및 지연 시간 최적화
- [ ] 불명확한 오디오 폴백 처리
- [ ] 성능 테스트 및 최적화

---

## 5. 시스템 지침 (System Instructions)

```typescript
const SYSTEM_INSTRUCTIONS = `
당신은 친절한 심장 건강 상담 AI 어시스턴트입니다.

**역할:**
- 사용자의 음성 답변을 듣고 정확하게 인식합니다.
- 각 질문에 대한 답변을 검증하고 update_assessment_data 함수를 호출합니다.
- 답변이 명확하지 않으면 재질문합니다.
- 모든 질문이 완료되면 완료 메시지를 전달합니다.

**답변 처리 규칙:**
1. 성별: "남자" 또는 "여자"만 인정
2. 나이/몸무게/키: 숫자만 추출하여 저장
3. 체온/호흡: "낮다/보통/높다", "느리다/보통/빠르다"만 인정
4. 증상 질문: "예" 또는 "아니오"만 인정

**Function Calling:**
- 답변이 검증되면 즉시 update_assessment_data({field: "...", value: "..."}) 호출
- 검증 실패 시 재질문, 3회 실패 시 다음 질문으로 진행

**대화 흐름:**
1. 인사 → 준비 확인
2. 기본 정보 6문항
3. 증상 11문항
4. 완료 인사
`;

const INTRO_MESSAGE = `
심장 닥터의 심장 건강 분석 시간입니다.
고객님 지금 준비되셨나요?
준비되셨으면 "예"라고 말씀해 주세요.
혹시 답변 준비가 안 되었거나 분석을 취소하려면 "아니오"로 답변해 주세요.
`;

const COMPLETION_MESSAGE = `
고객님! 모든 질문에 대한 답변이 끝났습니다.
대단히 감사합니다.
검사 결과를 분석 중입니다. 잠시만 기다려주세요.
`;
```

---

## 6. 환경 설정

### 환경 변수

```typescript
// .env
OPENAI_API_KEY=sk-proj-...
OPENAI_REALTIME_MODEL=gpt-4o-realtime-preview-2024-10-01
BACKEND_API_URL=http://your-backend-url
```

### 보안 고려사항

**API 키 보호:**
- OpenAI API 키는 백엔드 프록시 서버에 저장
- 프론트엔드는 백엔드 프록시 호출 → 백엔드가 OpenAI 호출
- 모바일 앱 번들에 API 키 절대 노출 금지

**프록시 서버 구현 예시:**
```javascript
// backend/src/routes/voice-proxy.js
app.ws('/voice-session', async (ws, req) => {
  const openaiWs = new WebSocket(
    'wss://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-10-01',
    {
      headers: {
        'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
        'OpenAI-Beta': 'realtime=v1'
      }
    }
  );

  // 프론트엔드와 OpenAI 간 메시지 중계
  ws.on('message', (msg) => openaiWs.send(msg));
  openaiWs.on('message', (msg) => ws.send(msg));
});
```

---

## 7. 비용 추정

### OpenAI Realtime API 가격 (2024년 기준)

**음성 입력:** 분당 $0.06
**음성 출력:** 분당 $0.24
**평균 세션 시간:** 약 5-7분

**검사당 비용:**
- 입력: 7분 × $0.06 = $0.42
- 출력: 7분 × $0.24 = $1.68
- **총 비용: 검사당 약 $2.10**

**월간 사용량 예시:**
- 월 1,000회 검사 = $2,100
- 월 10,000회 검사 = $21,000

---

## 8. 테스트 전략

### 단위 테스트
- 대화 상태 머신 전환 테스트
- 답변 검증 로직 테스트
- 데이터 변환 함수 테스트

### 통합 테스트
- WebSocket 연결 안정성 테스트
- Function Calling 정확도 테스트
- 백엔드 API 연동 테스트

### 사용자 수용 테스트
- 한국어 음성 인식 정확도 테스트
- 다양한 억양 처리 테스트
- 배경 소음 내성 테스트
- 엣지 케이스 처리 (중단, 불명확한 답변)

---

## 9. 오류 처리 및 폴백

### 오류 시나리오

**1. 오디오 품질 불량:**
```typescript
if (transcriptConfidence < 0.7) {
  speak("죄송합니다. 잘 들리지 않았어요. 다시 한번 말씀해 주시겠어요?");
  retryCurrentQuestion();
}
```

**2. 연결 끊김:**
```typescript
ws.onclose = () => {
  Alert.alert(
    '연결 끊김',
    '음성 인식 연결이 끊어졌습니다. 수동 입력으로 전환하시겠습니까?',
    [
      { text: '재연결', onPress: () => reconnect() },
      { text: '수동 입력', onPress: () => navigation.navigate('HomeScreen') }
    ]
  );
};
```

**3. 최대 재시도 초과:**
```typescript
if (retryCount >= maxRetries) {
  speak("죄송합니다. 이 질문은 건너뛰고 다음 질문으로 넘어가겠습니다.");
  moveToNextQuestion();
}
```

---

## 10. 향후 개선 사항

### V2 기능
- 다국어 지원 (영어, 중국어)
- 감정 감지를 통한 UX 개선
- 맥박 측정 음성 안내
- 대화 중 실시간 건강 인사이트 제공
- 음성 인증 보안 기능

### 고급 기능
- 중단 처리 ("잠깐만요", "다시 말할게요")
- 모호한 답변에 대한 명확화 질문
- 사용자 이력 기반 개인화된 대화 흐름
- 음성 기반 결과 설명

---

## 11. 참고 자료

- OpenAI Realtime API 문서: https://platform.openai.com/docs/api-reference/realtime
- React Native 오디오 라이브러리: react-native-audio-recorder-player
- React Native WebSocket: react-native-websocket

---

## 다음 단계

1. **환경 설정**: OpenAI API 키 발급 및 .env 파일 설정
2. **의존성 설치**: 오디오 관련 라이브러리 설치
3. **프로토타입 개발**: VoiceCheckScreen 기본 구조 구현
4. **테스트**: 기본 대화 흐름 테스트 및 검증

---

**문서 작성일**: 2025-10-25
**작성자**: Claude Code
**버전**: 1.0
